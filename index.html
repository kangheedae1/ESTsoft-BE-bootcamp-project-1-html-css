<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>new chat</title>


    <link rel="icon" type="image/png" href="favicon.png" />

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <py-config>
        packages = ["numpy","pandas"]
        [[fetch]]
        from = './py'
        files = ['request.py','bundle.py']
    </py-config>

</head>

<body>

    <div>
        <ul></ul>
        <form>
        <input type="text" />
        <button id="'button" type="submit">전송</button>
        </form>
        <div id="contents"></div>
    </div>


    <py-script>
        from bundle import bundling
        from request import request

        import asyncio
        import json
        import pandas as pd
        import numpy as np
        from pyodide.http import open_url
        from pyodide.ffi import create_proxy
        from js import document

        url = (
            "https://raw.githubusercontent.com/sunse523/ormi-dev-project-1/master/py/TOURISM.csv"
            )

        baseurl = "https://estsoft-openai-api.jejucodingcamp.workers.dev"    


        #pre-processing of dataset to create bunddle 
        data = pd.read_csv(open_url(url), sep=',', encoding= 'unicode_escape')
        data["TIME"] = 60
        new_data = data.loc[:,["OBJECTID","PAGETITLE","OVERVIEW", "IMAGE_PATH", 'LATITUDE', 'LONGTITUDE',"ADDRESS","OPENING_HO","TIME"]]
        new_data = new_data.loc[:,["OBJECTID", "LATITUDE", "LONGTITUDE", "TIME"]]
        new_data = new_data.values
        reference = bundling(new_data)
        

        rawData = data.to_json(orient="split")
        ref = json.dumps(reference)

        
        # pre-training with bundled dataset
        data = [
        {"role": "system","content": "assistant is tourism professional for Singapore"},
        {"role": "assistant", "content": f'this is bundled data of attractions based on provided raw dataset. each bunddle has at least 2 to 5 attractions in it. assistant will answer based on this data :{ref}'},
        ]


        input = document.querySelector("input");
        button = document.querySelector("button");
        chatList = document.querySelector("ul");


        # 화면에 뿌려줄 데이터, 질문들
        questionData = []


        # 화면에 질문 그려주는 함수
        def printQuestion():
            li = document.createElement("li")
            li.classList.add("question")
            for el in questionData:
                li.innerText = el["content"]
                chatList.appendChild(li)
            questionData.clear()


        #callback function as an input of addEventListner
        def eventPushData(e):
            e.preventDefault();
            userInputData = input.value;
            input.value = "";
            data.append({
                "role": "user",
                "content": userInputData})
            questionData.append({
                "role": "user",
                "content": userInputData})
            print(questionData)
            printQuestion()  
            asyncio.ensure_future(main())
            

        eventPush = create_proxy(eventPushData)
        button.addEventListener("click", eventPush);


        # 화면에 답변 그려주는 함수
        def printAnswer(answer):
            li = document.createElement("li")
            li.classList.add("answer")
            li.innerText = answer
            chatList.appendChild(li)        
        

        # chatGPT API communication
        async def main():
            headers = {"Content-type": "application/json"}
            body = json.dumps(data)
            response = await request(f"{baseurl}/", body=body, method="POST", headers=headers)
            res = await response.json()
            printAnswer(res["choices"][0]["message"])

    </py-script>


</body>
</html>