<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>chat</title>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>

    <py-config>
        packages = ["numpy","pandas"]
        [[fetch]]
        from = './py'
        files = ['request.py','bundle.py']
    </py-config>

</head>

<body>
    <div id="test">

    </div>

    <div>
        <form>
        <input type="text" />
        <button id="'button" type="submit">전송</button>
        </form>
        <div id="contents"></div>
    </div>




    <py-script>
        from bundle import bundling
        from request import request

        import asyncio
        import json
        import pandas as pd
        import numpy as np
        from pyodide.http import open_url
        from pyodide.ffi import create_proxy
        from js import document

        url = (
            "https://raw.githubusercontent.com/sunse523/ormi-dev-project-1/master/py/TOURISM.csv"
            )
        data = pd.read_csv(open_url(url), sep=',', encoding= 'unicode_escape')
        data["TIME"] = 60
        new_data = data.loc[:,["OBJECTID","PAGETITLE","OVERVIEW", "IMAGE_PATH", 'LATITUDE', 'LONGTITUDE',"ADDRESS","OPENING_HO","TIME"]]
        new_data = new_data.loc[:,["OBJECTID", "LATITUDE", "LONGTITUDE", "TIME"]]
        new_data = new_data.values
        reference = bundling(new_data)
        

        rawData = data.to_json(orient="split")
        ref = json.dumps(reference)

        

        d = [{"role": "system",
        "content": "assistant is tourism professional for Singapore"},]
        
        d.append({"role": "assistant",
        "content": reference})

        input = document.querySelector("input");
        button = document.querySelector("button");

        print(d)
        print(type(d))

        

        def eventPushData(e):
            e.preventDefault();
            userInputData = input.value;
            input.value = "";

            d.append({
                "role": "user",
                "content": userInputData,})
            chatGptAPI(d)
            
        eventPush = create_proxy(eventPushData)
        button.addEventListener("click", eventPush);


        


        # communication

        async def main():
            baseurl = "https://estsoft-openai-api.jejucodingcamp.workers.dev"
            headers = {"Content-type": "application/json"}
            body = json.dumps(d)
            new_post = await request(f"{baseurl}/posts", body=body, method="POST", headers=headers)
            

            data = await response.json()
            createCard(data)

        asyncio.ensure_future(main())

    </py-script>

 
    
    
    
    <!-- <script src="./js/chat.js"></script> -->



</body>
</html>
